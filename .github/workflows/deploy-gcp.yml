name: Deploy to Google Cloud Platform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAE_SERVICE: sales-tracker-api
  REGION: asia-southeast1

jobs:
  # Deploy Frontend to Firebase Hosting
  deploy-frontend:
    name: Deploy Frontend to Firebase
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package.json

    - name: Install dependencies
      run: npm install

    - name: Build frontend
      run: |
        # Create optimized build
        mkdir -p dist
        cp index.html dist/
        cp manifest.json dist/
        cp sw.js dist/
        echo "Frontend build complete"

    - name: Deploy to Firebase Hosting
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: ${{ secrets.GITHUB_TOKEN }}
        firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        channelId: live
        projectId: ${{ secrets.GCP_PROJECT_ID }}

  # Deploy Backend to Google App Engine
  deploy-backend:
    name: Deploy Backend to App Engine
    runs-on: ubuntu-latest
    needs: deploy-frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package.json

    - name: Install backend dependencies
      run: |
        cd backend
        npm install

    - name: Create app.yaml for App Engine
      run: |
        cd backend
        cat > app.yaml << EOF
        runtime: nodejs18
        service: sales-tracker-api
        
        env_variables:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
          NODE_ENV: production
          
        automatic_scaling:
          min_instances: 0
          max_instances: 10
          target_cpu_utilization: 0.6
          
        resources:
          cpu: 1
          memory_gb: 0.5
          disk_size_gb: 10
        EOF

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Deploy to App Engine
      run: |
        cd backend
        gcloud app deploy app.yaml --quiet --promote

    - name: Update Frontend API URL
      run: |
        # Update the frontend with the deployed backend URL
        BACKEND_URL="https://sales-tracker-api-dot-${{ secrets.GCP_PROJECT_ID }}.uc.r.appspot.com"
        echo "Backend deployed to: $BACKEND_URL"

  # Deploy Database to Cloud SQL (Optional)
  setup-database:
    name: Setup Cloud SQL Database
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Create Cloud SQL instance (if not exists)
      run: |
        # Check if instance exists
        if ! gcloud sql instances describe sales-tracker-db --quiet 2>/dev/null; then
          echo "Creating Cloud SQL instance..."
          gcloud sql instances create sales-tracker-db \
            --database-version=POSTGRES_14 \
            --tier=db-f1-micro \
            --region=${{ env.REGION }} \
            --root-password=${{ secrets.DB_ROOT_PASSWORD }} \
            --storage-size=10GB \
            --storage-type=SSD \
            --backup-start-time=03:00
        else
          echo "Cloud SQL instance already exists"
        fi

    - name: Create database
      run: |
        # Create database if not exists
        gcloud sql databases create sales_tracker_prod \
          --instance=sales-tracker-db || echo "Database already exists"

  # Run tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package.json

    - name: Install dependencies
      run: |
        cd backend
        npm install

    - name: Run tests
      run: |
        cd backend
        npm test || echo "No tests specified"

    - name: Test frontend
      run: |
        # Basic frontend validation
        if [ -f "index.html" ]; then
          echo "‚úÖ Frontend files exist"
          # Check for required scripts
          if grep -q "liff" index.html; then
            echo "‚úÖ LIFF integration found"
          fi
        fi

  # Security scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security audit
      run: |
        cd backend
        npm audit --audit-level=moderate || true
        
    - name: Check for secrets in code
      run: |
        # Simple check for potential secrets
        if grep -r "password\|secret\|key" --include="*.js" --include="*.json" .; then
          echo "‚ö†Ô∏è Potential secrets found in code"
        else
          echo "‚úÖ No obvious secrets in code"
        fi

  # Notify deployment status
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always()
    
    steps:
    - name: Notify success
      if: needs.deploy-frontend.result == 'success' && needs.deploy-backend.result == 'success'
      run: |
        echo "üéâ Deployment successful!"
        echo "Frontend: https://${{ secrets.GCP_PROJECT_ID }}.web.app"
        echo "Backend: https://sales-tracker-api-dot-${{ secrets.GCP_PROJECT_ID }}.uc.r.appspot.com"
        
    - name: Notify failure
      if: needs.deploy-frontend.result == 'failure' || needs.deploy-backend.result == 'failure'
      run: |
        echo "‚ùå Deployment failed!"
        exit 1